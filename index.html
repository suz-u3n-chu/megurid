<!DOCTYPE html>
<html lang="ja" class="scroll-smooth antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MEGURID | Digital Wabi-Sabi</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              serif: ['"Playfair Display"', '"Noto Serif JP"', 'serif'],
              sans: ['"Noto Serif JP"', 'serif'], 
              mono: ['"Space Mono"', 'monospace'],
            },
            colors: {
              paper: '#fcfcfc',
              ink: '#1a1a1a',
              subtle: '#f5f5f4',
              border: '#e7e5e4',
              vermilion: '#cd3e30', 
              gold: '#c5a059',
            },
            animation: {
              'fade-up': 'fadeUp 1.0s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              'slide-in-right': 'slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              fadeUp: {
                '0%': { opacity: '0', transform: 'translateY(40px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              slideInRight: {
                '0%': { transform: 'translateX(100%)' },
                '100%': { transform: 'translateX(0)' },
              }
            }
          }
        }
      }
    </script>

    <!-- Import Map for Google GenAI -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
  }
}
</script>

    <style>
      /* Global Custom Styles */
      body {
          background-color: #fcfcfc;
          color: #1a1a1a;
          overflow-x: hidden;
      }

      /* Washi Paper Texture */
      .washi-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          pointer-events: none;
          z-index: 40;
          opacity: 0.6;
          mix-blend-mode: multiply;
          background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
          width: 4px;
      }
      ::-webkit-scrollbar-track {
          background: transparent;
      }
      ::-webkit-scrollbar-thumb {
          background: #cd3e30;
          border-radius: 2px;
      }

      ::selection {
          background: #cd3e30; 
          color: #ffffff;
      }

      .writing-vertical {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        letter-spacing: 0.2em;
      }
      
      .writing-vertical-upright {
        writing-mode: vertical-rl;
        text-orientation: upright;
        letter-spacing: 0.3em;
      }

      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="washi-overlay"></div>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
      import { GoogleGenAI } from "@google/genai";

      const { useState, useEffect, useRef } = React;

      // --- Data ---
      // 画像を「コンクリート・石・影・ミニマル」なものに刷新
      const PRODUCTS = [
          { id: '01', category: 'vessel', name: '器 - UTSUWA', price: 3300, img: 'https://images.unsplash.com/photo-1610701596007-11502861dcfa?q=80&w=1760&auto=format&fit=crop', desc: '光を受け止める皿' },
          { id: '02', category: 'vessel', name: '窪 - KUBOMI', price: 3100, img: 'https://images.unsplash.com/photo-1590439471364-192aa70c0b53?q=80&w=2574&auto=format&fit=crop', desc: '静寂を溜める器' },
          { id: '03', category: 'tray', name: '舟 - FUNE', price: 2400, img: 'https://images.unsplash.com/photo-1616593871221-7298c4746401?q=80&w=1740&auto=format&fit=crop', desc: '時の流れを運ぶ' },
          { id: '04', category: 'object', name: '塊 - KATAMARI', price: 4500, img: 'https://images.unsplash.com/photo-1517153721323-5e771413fa7b?q=80&w=1740&auto=format&fit=crop', desc: '重力を可視化する' },
          { id: '05', category: 'object', name: '柱 - HASHIRA', price: 5200, img: 'https://images.unsplash.com/photo-1589158525769-d4191d96637b?q=80&w=1887&auto=format&fit=crop', desc: '空間を支える概念' },
          { id: '06', category: 'tray', name: '平 - TAIRA', price: 2800, img: 'https://images.unsplash.com/photo-1606561571274-0f2c4187e35e?q=80&w=1740&auto=format&fit=crop', desc: '無垢なる水平面' },
      ];

      // --- Icons ---
      const Icons = {
        Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
        X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
        ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
        Message: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>,
        Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
        Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>,
        Bag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>,
        Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
        Trash: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
        Maximize: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="square" strokeLinejoin="miter" {...props}><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      };

      // --- Animation Hooks ---
      const useInView = (options = { threshold: 0.1 }) => {
        const ref = useRef(null);
        const [isInView, setIsInView] = useState(false);
        useEffect(() => {
          const observer = new IntersectionObserver(([entry]) => {
            if (entry.isIntersecting) {
              setIsInView(true);
              observer.unobserve(entry.target);
            }
          }, options);
          if (ref.current) observer.observe(ref.current);
          return () => { if (ref.current) observer.unobserve(ref.current); };
        }, [options]);
        return [ref, isInView];
      };

      const Reveal = ({ children, delay = 0, className = "" }) => {
        const [ref, isInView] = useInView();
        return (
          <div ref={ref} className={`transition-all duration-1000 transform ${isInView ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-20'} ${className}`} style={{ transitionDelay: `${delay}ms` }}>
            {children}
          </div>
        );
      };

      const ParallaxImage = ({ src, alt, speed = 0.1, className = "", containerClass = "" }) => {
        const [offset, setOffset] = useState(0);
        const [ref, isInView] = useInView({ threshold: 0 });
        useEffect(() => {
          const handleScroll = () => { if (window.innerWidth > 768) setOffset(window.scrollY * speed); };
          window.addEventListener('scroll', handleScroll);
          return () => window.removeEventListener('scroll', handleScroll);
        }, [speed]);
        return (
          <div className={`overflow-hidden relative ${containerClass}`}>
            <div className={`w-full h-full transition-transform duration-100 ease-linear ${className}`} style={{ transform: `translateY(${offset}px) scale(1.1)` }}>
                <img src={src} alt={alt} className="w-full h-full object-cover" />
            </div>
            <div ref={ref} className={`absolute inset-0 bg-paper z-10 transition-transform duration-[1.5s] ease-expo origin-top ${isInView ? 'scale-y-0' : 'scale-y-100'}`}></div>
          </div>
        );
      };

      // --- Services ---
      const getChatResponse = async (message, history) => {
        try {
          const apiKey = process.env.API_KEY || ''; 
          if (!apiKey && (!window.aistudio || !await window.aistudio.hasSelectedApiKey())) return "申し訳ありません。APIキーが必要です。";
          const ai = new GoogleGenAI({ apiKey: apiKey || (await window.aistudio.getApiKey()) });
          const chatSession = ai.chats.create({
            model: 'gemini-3-pro-preview',
            config: { systemInstruction: "あなたは「MEGURID」の賢者（Kenja）です。コンクリートとデジタルの融合、わびさびについて深く理解しています。口調は丁寧で、少し古風で詩的。短く、本質を突く回答を好みます。" },
            history: history.map(h => ({ role: h.role, parts: h.parts }))
          });
          const response = await chatSession.sendMessage({ message });
          return response.text || "沈黙が答えです。";
        } catch (error) { return "気配を感じ取れませんでした。もう一度お試しください。"; }
      };

      const generateDesignImage = async (prompt, size) => {
        try {
          const apiKey = process.env.API_KEY; 
          const ai = new GoogleGenAI({ apiKey: apiKey });
          const response = await ai.models.generateContent({
            model: 'gemini-3-pro-image-preview',
            contents: { parts: [{ text: prompt }] },
            config: { imageConfig: { imageSize: size, aspectRatio: "1:1" } }
          });
          for (const part of response.candidates?.[0]?.content?.parts || []) {
            if (part.inlineData) return `data:image/png;base64,${part.inlineData.data}`;
          }
          throw new Error("生成に失敗しました。");
        } catch (error) { throw error; }
      };

      // --- Components ---

      // Sidebar Navigation
      const Navigation = ({ onNavigate, currentView, cartCount, onOpenCart }) => {
        return (
          <nav className="fixed top-0 left-0 h-full w-20 md:w-24 z-50 border-r border-border bg-paper/80 backdrop-blur-sm hidden md:flex flex-col items-center justify-between py-12 transition-all duration-500">
            <div className="cursor-pointer" onClick={() => onNavigate('HOME')}>
                <div className="w-10 h-10 border border-ink flex items-center justify-center font-serif text-xl hover:bg-ink hover:text-paper transition-colors duration-500">巡</div>
            </div>
            <div className="flex flex-col gap-12 items-center writing-vertical">
                <button onClick={() => onNavigate('HOME')} className={`text-xs tracking-widest hover:text-vermilion transition-colors ${currentView === 'HOME' ? 'text-ink font-bold' : 'text-gray-400'}`}>本館 - HOME</button>
                <button onClick={() => onNavigate('STORE')} className={`text-xs tracking-widest hover:text-vermilion transition-colors ${currentView === 'STORE' ? 'text-ink font-bold' : 'text-gray-400'}`}>商店 - STORE</button>
                <button onClick={() => onNavigate('GENERATE')} className={`text-xs tracking-widest hover:text-vermilion transition-colors ${currentView === 'GENERATE' ? 'text-ink font-bold' : 'text-gray-400'}`}>工房 - ATELIER</button>
            </div>
            <button onClick={onOpenCart} className="relative group">
                <Icons.Bag size={20} className="text-ink group-hover:text-vermilion transition-colors" />
                {cartCount > 0 && <span className="absolute -top-1 -right-1 w-3 h-3 bg-vermilion rounded-full animate-bounce"></span>}
            </button>
          </nav>
        );
      };

      // Mobile Header
      const MobileHeader = ({ onNavigate, cartCount, onOpenCart }) => {
        const [open, setOpen] = useState(false);
        return (
            <header className="md:hidden fixed top-0 w-full z-50 bg-paper/90 backdrop-blur border-b border-border p-4 flex justify-between items-center">
                <span className="font-serif text-xl font-bold">MEGURID</span>
                <div className="flex items-center gap-4">
                    <button onClick={onOpenCart} className="relative">
                        <Icons.Bag size={24} />
                        {cartCount > 0 && <span className="absolute -top-1 -right-1 w-2 h-2 bg-vermilion rounded-full"></span>}
                    </button>
                    <button onClick={() => setOpen(!open)}>
                        {open ? <Icons.X /> : <Icons.Menu />}
                    </button>
                </div>
                {open && (
                    <div className="absolute top-full left-0 w-full bg-paper h-screen p-8 flex flex-col gap-8 animate-fade-up">
                        <button onClick={() => { onNavigate('HOME'); setOpen(false); }} className="text-2xl font-serif text-left border-b border-gray-100 pb-4">本館 Home</button>
                        <button onClick={() => { onNavigate('STORE'); setOpen(false); }} className="text-2xl font-serif text-left border-b border-gray-100 pb-4">商店 Store</button>
                        <button onClick={() => { onNavigate('GENERATE'); setOpen(false); }} className="text-2xl font-serif text-left border-b border-gray-100 pb-4">工房 Atelier</button>
                    </div>
                )}
            </header>
        );
      };

      // Cart Drawer
      const CartDrawer = ({ isOpen, onClose, cart, onRemove }) => {
        if (!isOpen) return null;
        const total = cart.reduce((acc, item) => acc + item.price, 0);

        return (
            <div className="fixed inset-0 z-[60] flex justify-end">
                <div className="absolute inset-0 bg-ink/20 backdrop-blur-sm" onClick={onClose}></div>
                <div className="relative w-full md:w-[400px] h-full bg-paper border-l border-border shadow-2xl animate-slide-in-right flex flex-col">
                    <div className="p-6 border-b border-border flex justify-between items-center bg-subtle">
                        <h2 className="font-serif text-xl">買い物袋 - BAG</h2>
                        <button onClick={onClose}><Icons.X /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                        {cart.length === 0 ? (
                            <div className="text-center text-gray-400 font-serif mt-20">何も入っていません。</div>
                        ) : (
                            cart.map((item, idx) => (
                                <div key={idx} className="flex gap-4 animate-fade-up">
                                    <img src={item.img} alt={item.name} className="w-20 h-20 object-cover bg-gray-100" />
                                    <div className="flex-1 flex flex-col justify-between">
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-serif">{item.name}</h3>
                                            <button onClick={() => onRemove(idx)} className="text-gray-400 hover:text-vermilion"><Icons.Trash size={16}/></button>
                                        </div>
                                        <span className="font-mono text-sm">¥{item.price.toLocaleString()}</span>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    <div className="p-6 border-t border-border bg-subtle">
                        <div className="flex justify-between items-end mb-6">
                            <span className="font-serif text-sm">合計</span>
                            <span className="font-mono text-xl font-bold">¥{total.toLocaleString()}</span>
                        </div>
                        <button className="w-full py-4 bg-ink text-white font-serif hover:bg-vermilion transition-colors disabled:opacity-50" disabled={cart.length === 0}>
                            手続きへ - CHECKOUT
                        </button>
                    </div>
                </div>
            </div>
        );
      };

      // Hero Section
      const Hero = ({ onNavigate }) => {
        return (
            <section className="relative min-h-screen w-full overflow-hidden flex items-center bg-paper">
                <div className="container mx-auto px-6 md:px-12 flex flex-col-reverse md:flex-row h-full items-center justify-center md:justify-between gap-12 pt-20 md:pt-0">
                    <div className="w-full md:w-1/2 h-[50vh] md:h-[80vh] relative z-10">
                        {/* ヒーロー画像を印象的なコンクリート建築・光と影のものに変更 */}
                        <ParallaxImage src="https://images.unsplash.com/photo-1487958449943-2429e8be8625?q=80&w=2670&auto=format&fit=crop" alt="Brutalist Architecture" speed={0.15} className="grayscale contrast-125" containerClass="w-full h-full shadow-2xl" />
                    </div>
                    <div className="w-full md:w-1/2 h-full flex flex-col justify-center md:pl-16 z-20">
                         <Reveal delay={100}>
                            {/* 横書きタイトルに変更 */}
                            <h1 className="text-5xl md:text-8xl font-serif font-thin tracking-widest leading-none">MEGURID</h1>
                         </Reveal>
                         <Reveal delay={300}>
                            {/* 小タイトルとして配置 */}
                            <p className="text-lg md:text-xl font-serif text-gray-500 tracking-[0.4em] mt-4 ml-1">巡り出会う</p>
                         </Reveal>
                         
                         <div className="flex flex-col justify-center space-y-8 mt-12">
                            <Reveal delay={500}>
                                <p className="font-serif text-sm md:text-base leading-loose text-gray-600">静寂を象る。<br/>デジタルと物質の境界線で、<br/>新たな「わびさび」を探求する。</p>
                            </Reveal>
                            <Reveal delay={700}>
                                <button onClick={() => onNavigate('STORE')} className="group relative w-fit px-8 py-4 overflow-hidden border border-ink text-ink font-mono text-xs tracking-widest hover:text-white transition-colors duration-300">
                                    <span className="absolute inset-0 w-full h-full bg-ink transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300 ease-out"></span>
                                    <span className="relative z-10 flex items-center gap-2">VISIT STORE <Icons.ArrowRight size={14} /></span>
                                </button>
                            </Reveal>
                         </div>
                    </div>
                </div>
            </section>
        );
      };

      const Philosophy = () => {
        return (
            <section className="py-32 bg-paper relative">
                <div className="container mx-auto px-6 md:pl-40 flex flex-col md:flex-row gap-24">
                    <div className="hidden md:flex flex-col justify-start h-[500px]">
                        <span className="writing-vertical text-xs tracking-[0.4em] text-gray-400 border-l border-gray-200 py-4">美学について - PHILOSOPHY</span>
                    </div>
                    <div className="flex-1 space-y-32">
                        <div className="flex flex-col md:flex-row gap-12 items-center">
                            <div className="md:w-1/2">
                                <Reveal><h2 className="text-3xl md:text-4xl font-serif mb-8 leading-snug">不完全さを、<br/>愛でる。</h2><p className="font-serif text-gray-600 leading-loose text-justify">コンクリートのひび割れ、気泡、色むら。それらは欠陥ではなく、素材が持つ「声」です。</p></Reveal>
                            </div>
                            <div className="md:w-1/2 w-full h-[400px]"><ParallaxImage src="https://images.unsplash.com/photo-1596525737526-787884d8550d?q=80&w=2574&auto=format&fit=crop" alt="Concrete Texture" speed={0.05} className="grayscale opacity-80" containerClass="w-full h-full" /></div>
                        </div>
                    </div>
                </div>
                <div className="absolute left-6 md:left-24 top-0 h-full w-[1px] bg-border z-0"></div>
            </section>
        );
      };

      // Featured Gallery (Home)
      const FeaturedGallery = ({ onNavigate }) => {
        return (
            <section className="py-24 bg-subtle relative overflow-hidden">
                <div className="container mx-auto px-6 md:pl-40">
                    <div className="flex justify-between items-end mb-20 border-b border-gray-300 pb-6">
                        <Reveal><h2 className="text-4xl md:text-5xl font-serif">収集 - COLLECTION</h2></Reveal>
                        <button onClick={() => onNavigate('STORE')} className="font-mono text-xs hidden md:block hover:text-vermilion transition-colors">VIEW ALL PRODUCTS -></button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-20">
                        {PRODUCTS.slice(0, 4).map((p, i) => (
                            <Reveal key={p.id} delay={i * 100}>
                                <div className="group cursor-pointer" onClick={() => onNavigate('STORE')}>
                                    <div className="relative aspect-[3/4] overflow-hidden bg-white mb-6 shadow-lg group-hover:shadow-2xl transition-shadow duration-500">
                                        <img src={p.img} alt={p.name} className="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-[1.5s] ease-out grayscale group-hover:grayscale-0" />
                                    </div>
                                    <div className="flex justify-between items-baseline border-t border-ink pt-3">
                                        <h3 className="text-xl font-serif">{p.name}</h3>
                                        <span className="font-mono text-sm">¥{p.price.toLocaleString()}</span>
                                    </div>
                                </div>
                            </Reveal>
                        ))}
                    </div>
                </div>
            </section>
        );
      };

      // Store Page
      const Store = ({ onAddToCart }) => {
        const [filter, setFilter] = useState('all');
        const categories = [
            { id: 'all', label: '全て' },
            { id: 'vessel', label: '器' },
            { id: 'tray', label: '盆' },
            { id: 'object', label: 'オブジェ' }
        ];

        const filteredProducts = filter === 'all' ? PRODUCTS : PRODUCTS.filter(p => p.category === filter);

        return (
            <div className="min-h-screen bg-paper pt-24 md:pl-24 animate-fade-up">
                <div className="container mx-auto px-6 flex flex-col md:flex-row min-h-[80vh]">
                    
                    {/* Filters (Vertical) */}
                    <div className="md:w-32 py-12 md:fixed md:h-screen top-24 left-24 z-10 bg-paper">
                         <div className="hidden md:block absolute right-0 top-0 bottom-0 w-[1px] bg-border"></div>
                        <div className="flex md:flex-col gap-8 md:gap-12 justify-center md:items-center writing-vertical">
                            {categories.map(cat => (
                                <button 
                                    key={cat.id} 
                                    onClick={() => setFilter(cat.id)}
                                    className={`text-sm tracking-[0.3em] transition-all duration-300 py-2 ${filter === cat.id ? 'text-vermilion font-bold border-l-2 border-vermilion scale-110' : 'text-gray-400 hover:text-ink'}`}
                                >
                                    {cat.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Product Grid */}
                    <div className="flex-1 md:pl-40 py-12">
                         <div className="border-b border-gray-200 pb-6 mb-12 flex justify-between items-end">
                            <h2 className="text-4xl font-serif">商店 - STORE</h2>
                            <span className="font-mono text-xs text-gray-500">{filteredProducts.length} ITEMS</span>
                         </div>

                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-16">
                            {filteredProducts.map((p, i) => (
                                <Reveal key={p.id} delay={i * 50}>
                                    <div className="group relative">
                                        <div className="relative aspect-square bg-subtle overflow-hidden mb-4 shadow-sm hover:shadow-xl transition-shadow duration-500">
                                            <img src={p.img} alt={p.name} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                                            {/* Overlay */}
                                            <div className="absolute inset-0 bg-ink/80 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col items-center justify-center text-white p-6 text-center">
                                                <p className="font-serif italic mb-6 text-sm">{p.desc}</p>
                                                <button 
                                                    onClick={() => onAddToCart(p)}
                                                    className="px-6 py-3 border border-white hover:bg-white hover:text-ink transition-colors font-mono text-xs tracking-widest flex items-center gap-2"
                                                >
                                                    <Icons.Plus size={14}/> ADD TO BAG
                                                </button>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="font-serif text-lg">{p.name}</h3>
                                                <p className="text-xs text-gray-500 font-mono mt-1 uppercase">{p.category}</p>
                                            </div>
                                            <span className="font-mono text-sm">¥{p.price.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </Reveal>
                            ))}
                         </div>
                    </div>
                </div>
            </div>
        );
      };

      // Atelier (Image Gen)
      const Atelier = () => {
        const [prompt, setPrompt] = useState('');
        const [size, setSize] = useState('1K');
        const [image, setImage] = useState(null);
        const [loading, setLoading] = useState(false);
        const [apiKeyReady, setApiKeyReady] = useState(false);

        useEffect(() => {
            const check = async () => { if (window.aistudio) setApiKeyReady(await window.aistudio.hasSelectedApiKey()); };
            check();
        }, []);

        const handleKey = async () => { if (window.aistudio) { await window.aistudio.openSelectKey(); setApiKeyReady(true); } };

        const generate = async () => {
            if (!prompt) return;
            setLoading(true);
            try {
                const res = await generateDesignImage(prompt, size);
                setImage(res);
            } catch (e) {
                if (e.message && e.message.includes('Requested entity was not found')) {
                    setApiKeyReady(false);
                    await handleKey();
                }
            } finally { setLoading(false); }
        };

        return (
            <div className="min-h-screen bg-paper pt-24 md:pl-32">
                <div className="container mx-auto px-6">
                    <div className="border-b border-vermilion pb-6 mb-12">
                        <h2 className="text-4xl md:text-6xl font-serif mb-2">電子工房 - ATELIER</h2>
                        <p className="font-mono text-xs text-gray-500">GENERATIVE CONCRETE PROTOTYPING</p>
                    </div>
                    <div className="flex flex-col lg:flex-row gap-12">
                        <div className="w-full lg:w-1/3 bg-subtle p-8 border border-border h-fit">
                            <div className="space-y-8">
                                <div>
                                    <label className="font-serif text-sm block mb-4 border-l-2 border-vermilion pl-3">解像度選択</label>
                                    <div className="flex gap-4">{['1K', '2K', '4K'].map(s => <button key={s} onClick={() => setSize(s)} className={`flex-1 py-3 border font-mono text-xs transition-colors ${size === s ? 'bg-ink text-paper border-ink' : 'bg-transparent border-gray-300 hover:border-ink'}`}>{s}</button>)}</div>
                                </div>
                                <div>
                                    <label className="font-serif text-sm block mb-4 border-l-2 border-vermilion pl-3">意匠の記述</label>
                                    <textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder="例：静寂な空間に置かれた、苔むしたコンクリートの茶器。自然光。" className="w-full h-40 bg-white border border-gray-300 p-4 font-serif text-sm focus:outline-none focus:border-ink resize-none" />
                                </div>
                                {!apiKeyReady && window.aistudio ? (
                                    <button onClick={handleKey} className="w-full py-4 bg-gold text-white font-serif hover:opacity-90 transition-opacity">鍵（API Key）を接続</button>
                                ) : (
                                    <button onClick={generate} disabled={loading || !prompt} className="w-full py-4 bg-ink text-white font-serif tracking-widest hover:bg-vermilion transition-colors disabled:opacity-50">{loading ? '生成中...' : '生成 - GENERATE'}</button>
                                )}
                            </div>
                        </div>
                        <div className="w-full lg:w-2/3 aspect-square bg-white border border-border flex items-center justify-center relative overflow-hidden shadow-inner">
                            <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
                            {image ? (
                                <div className="relative w-full h-full p-8 animate-fade-up">
                                    <img src={image} alt="Generated" className="w-full h-full object-contain drop-shadow-2xl" />
                                    <a href={image} download="megurid.png" className="absolute bottom-8 right-8 p-4 bg-white border border-ink hover:bg-ink hover:text-white transition-colors"><Icons.Download /></a>
                                </div>
                            ) : (
                                <div className="text-center text-gray-300 font-serif"><Icons.Sparkles className="mx-auto mb-4 w-12 h-12 opacity-50" /><p>未だ、形無きもの。</p></div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
      };

      // Chat Widget (Sage)
      const Sage = () => {
        const [open, setOpen] = useState(false);
        const [messages, setMessages] = useState([{ role: 'model', text: 'ようこそ。何かお探しですか？言葉を紡いでください。' }]);
        const [input, setInput] = useState('');
        const [loading, setLoading] = useState(false);
        const scrollRef = useRef(null);

        useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages, open]);

        const send = async () => {
            if (!input.trim()) return;
            const userMsg = { role: 'user', text: input };
            setMessages(prev => [...prev, userMsg]);
            setInput('');
            setLoading(true);
            const hist = messages.map(m => ({ role: m.role, parts: [{ text: m.text }] }));
            const res = await getChatResponse(userMsg.text, hist);
            setMessages(prev => [...prev, { role: 'model', text: res }]);
            setLoading(false);
        };

        return (
            <>
                <button onClick={() => setOpen(!open)} className="fixed bottom-8 right-8 z-50 w-14 h-14 bg-ink text-paper rounded-full flex items-center justify-center shadow-2xl hover:bg-vermilion transition-colors duration-500">{open ? <Icons.X /> : <Icons.Message />}</button>
                {open && (
                    <div className="fixed bottom-28 right-4 md:right-8 w-[90vw] md:w-[350px] h-[500px] bg-paper border border-gray-200 shadow-2xl flex flex-col animate-fade-up z-40">
                        <div className="p-4 border-b border-border bg-subtle flex justify-between items-center"><span className="font-serif text-sm">賢者 - SAGE</span><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div></div>
                        <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-white/50">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] p-3 text-sm font-serif leading-relaxed ${m.role === 'user' ? 'bg-ink text-white' : 'bg-subtle text-ink border border-gray-100'}`}>{m.text}</div>
                                </div>
                            ))}
                            {loading && <div className="text-xs text-gray-400 font-serif p-2">思案中...</div>}
                        </div>
                        <div className="p-3 border-t border-border flex gap-2">
                            <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && send()} placeholder="問いかける..." className="flex-1 bg-transparent border-b border-gray-300 focus:border-ink outline-none font-serif text-sm p-2" />
                            <button onClick={send} className="text-ink hover:text-vermilion"><Icons.ArrowRight /></button>
                        </div>
                    </div>
                )}
            </>
        );
      };

      // App Root
      const App = () => {
        const [view, setView] = useState('HOME');
        const [cart, setCart] = useState([]);
        const [isCartOpen, setIsCartOpen] = useState(false);

        useEffect(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, [view]);

        const addToCart = (product) => {
            setCart([...cart, product]);
            setIsCartOpen(true);
        };

        const removeFromCart = (index) => {
            const newCart = [...cart];
            newCart.splice(index, 1);
            setCart(newCart);
        };

        return (
            <div className="min-h-screen font-sans selection:bg-vermilion selection:text-white">
                <Navigation onNavigate={setView} currentView={view} cartCount={cart.length} onOpenCart={() => setIsCartOpen(true)} />
                <MobileHeader onNavigate={setView} cartCount={cart.length} onOpenCart={() => setIsCartOpen(true)} />
                
                <main>
                    {view === 'HOME' && (
                        <div className="animate-fade-up">
                            <Hero onNavigate={setView} />
                            <Philosophy />
                            <FeaturedGallery onNavigate={setView} />
                            <footer className="py-12 text-center font-serif text-xs text-gray-400 border-t border-border mt-12"><p>© 2025 MEGURID - STONE & CODE</p></footer>
                        </div>
                    )}
                    
                    {view === 'STORE' && (
                        <div className="animate-fade-up">
                            <Store onAddToCart={addToCart} />
                            <footer className="py-12 text-center font-serif text-xs text-gray-400 border-t border-border mt-12"><p>© 2025 MEGURID - STONE & CODE</p></footer>
                        </div>
                    )}

                    {view === 'GENERATE' && (
                        <div className="animate-fade-up">
                            <Atelier />
                        </div>
                    )}
                </main>

                <CartDrawer isOpen={isCartOpen} onClose={() => setIsCartOpen(false)} cart={cart} onRemove={removeFromCart} />
                <Sage />
            </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>